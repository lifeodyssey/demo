# バックエンドデモ
このコードリポジトリは、KotlinとSpringに基づいたバックエンドマイクロサービスアーキテクチャでの基本的なCRUD操作とユーザー認証を実演しています。

![gxp 1107.png](gxp%201107.png)


## ローカルでの実行方法は？!

まず、ローカルマシンにdocker gradle がインストールされていることを確認してください。次に、このブランチをクローンしてターミナルで開いてください。

```bash
git switch gxp
chmod 755 ./BuildAndDeployToLocal.sh
./BuildAndDeployToLocal.sh
```
dockerはイメージをビルドし、bookサービス、bffサービス、そしてMongoDBを含むサービスをローカルで実行します。

./http/rest-api.httpを開いてローカル環境で実行してテストすることができます（Idea Ultimate Editionを使用し、[IDEA HTTP Client plugin]( https://plugins.jetbrains.com/plugin/13121-http-client)がインストールされていることを確認してください）。

![test result.png](test%20result.png)

このリポジトリは主にKotlinで書かれていますが、Javaerにも読みやすいはずです（実際、最新のJava文法は自動型推論など、Kotlinに近づいています）。

## このデモのハイライト

- マイクロサービスの基本アーキテクチャ
    - Backend for Frontend（BFF）: 異なる単一サービスからのレスポンスを結合し、認証、サーキットブレーカー、レートリミッター、リダイレクションなどの技術的問題を処理します。
    - 認証と承認: 異なるAPIに対して異なる権限を持つ基本認証をspringセキュリティで設定します。
    - 単一責任の原則: 異なるマイクロサービスとBFFレイヤーを分離することで、この原則を達成しました。
- ネットワークの隔離: BFFレイヤーは公開されていますが、bookサービスとMongoDBはプライベートネットワークで実行されています。bookサービスの唯一のインターフェースはBFFです。
- フック、リント、テストカバレッジプラグイン: githookは/.githooks下に設定されています。有効にすると、テストカバレッジチェックとリントチェックをパスできないコードはリモートリポジトリにプッシュできません。
- テスト: Junit、Mockk、WireMockに基づいてユニットテスト、アプリケーションテスト、統合テストが実装されています。
- データベースマイグレーション: データスキーマの変更時にmongockを使用してデータベースマイグレーションを行います。これはPostgreSQLのflywayに相当します。

## このデモの欠点
- セキュリティ: このプロジェクトでは、すべてのクレデンシャルとURLがコード内にハードコードされており、実際の開発での本番コードの要件を満たしていません。これらのクレデンシャルは環境変数から取得し、インフラ設定（AWS Secrets Managerなど）から注入されるべきです。
- 認証サービスはHTTPスクリプト以外で実際にはテストされておらず、単一サービスとして実装されているわけではありません。
- 現在いくつかのcode smellがあります。例えば、
  - PUTリクエストはリクエストボディとしてmapを使用すべきです。
  - テストでは同じデータを使用しているのでfixtureを抽出すべきです。
  - このリポジトリにCI/CDパイプラインの設定がありません。今は：'BuildAndDeploToLocal.sh'　を使でいます。
  - 総テストカバレッジは約80％、ブランチ特定のテストカバレッジは約50％となっており、BFFにおいては非常に低い水準です。
  - apiTestが実装されておらず、統合テストも完全には実装されていません。
  - インメモリMongoDBの設定（de.flapdoodle.embed.mongo.version）がBFFレイヤーに表示されていますが、明らかにここには存在すべきではありません。
  - インフラ関連の設定（MongoDB、docker composeファイルなど）はすべてこのリポジトリ内に記述されており、インフラ・アズ・コードの方法で別のリポジトリにあるべきです。
  - - BigDecimalはDoubleと比較して高精度な計算（16桁以上）を扱うことができ、金銭計算のような高精度が求められる計算にのみ使用すべきです。このプロジェクトでは、「Rates」オブジェクト内の「Rate」にBigDecimalを使用しています。